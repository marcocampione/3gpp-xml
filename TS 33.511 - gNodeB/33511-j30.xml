<?xml version="1.0" ?>
<Specification name="3GPP TS 33.511">
  <Section title="Foreword" level="1"/>
  <Section title="1	Scope" level="1"/>
  <Section title="2	References" level="1"/>
  <Section title="3	Definitions of terms and abbreviations" level="1">
    <Section title="3.1	Terms" level="2"/>
    <Section title="3.2	Abbreviations" level="2"/>
  </Section>
  <Section title="4	gNodeB-specific security requirements and related test cases" level="1">
    <Section title="4.1	Introduction" level="2"/>
    <Section title="4.2	gNodeB-specific security functional adaptations of requirements and related test cases" level="2">
      <Section title="4.2.1	Introduction" level="3"/>
      <Section title="4.2.2	Security functional requirements on the gNodeB deriving from 3GPP specifications and related test cases" level="3">
        <Section title="4.2.2.1	Security functional requirements on the gNodeB deriving from 3GPP specifications – TS 33.501 [2]" level="4">
          <Section title="4.2.2.1.1	Integrity protection of RRC-signalling" level="5">
            <Requirement>
              <Name>Integrity protection of RRC-signalling</Name>
              <Reference>TS 33.501 [2], clause 5.3.3</Reference>
              <Description>The gNB supports integrity protection and replay protection of RRC-signalling as specified in TS 33.501 [2], clause 5.3.3.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.2 – Control plane data integrity protection.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC_CP_DATA_INT_RRC-SIGN_gNB</Name>
              <Purpose>To verify that the RRC-signalling data sent between UE and gNB over the NG RAN air interface are integrity protected.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. UE may be simulated.
-	Tester shall have access to the integrity algorithm and the integrity protection keys.
-	The tester can capture the message via the NG RAN air interface, or can capture the message at the UE.
-	The NIA0 is disabled at UE and gNB.</Purpose>
              <ExecutionSteps>1.	The tester triggers the gNB to send AS SMC message to the UE, and UE responses AS SMP.
2.	The tester checks any RRC message sent by gNB after sending AS SMC and before UE enters CM-Idle state is integrity protected.</ExecutionSteps>
              <ExpectedResults>Any RRC-signalling over the NG RAN air interface is integrity protected after gNB sending AS SMC.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface, e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.2	Integrity protection of user data between the UE and the gNB" level="5">
            <Requirement>
              <Name>Integrity protection of user data between the UE and the gNB.</Name>
              <Reference>TS 33.501 [2], clause 5.3.3</Reference>
              <Description>The gNB supports integrity protection and replay protection of user data between the UE and the gNB as specified in TS 33.501 [2], clause 5.3.3.
NOTE: 	This requirement does not apply to the gNB that is used as a secondary node connecting to the EPC.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.4 – User plane data integrity protection.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-UP-DATA-INT_gNB</Name>
              <Purpose>To verify that the user data packets are integrity protected over the NG RAN air interface.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. UE may be simulated.
-	Tester shall enable the user plane integrity protection and ensure NIA0 is not used.
-	Tester shall have knowledge of integrity algorithm and integrity protection keys.
-	The tester can capture the message via the NG RAN air interface, or can capture the message at the UE.
-	The NIA0 is disabled at the UE and gNB.</Purpose>
              <ExecutionSteps>1.	The tester triggers the gNB to send RRCConnectionReconfiguration with integrity protection indication &quot;on&quot;.
2.	The tester checks any User data sent by gNB after sending RRCConnectionReconfiguration and before UE enters CM-Idle state is Integrity protected.</ExecutionSteps>
              <ExpectedResults>Any user plane packets sent between UE and gNB over the NG RAN air interface after gNB sending RRCConnectionReconfiguration is integrity protected.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.3	VOID" level="5"/>
          <Section title="4.2.2.1.4	RRC integrity check failure" level="5">
            <Requirement>
              <Name>RRC integrity check failure</Name>
              <Reference>TS 33.501 [2], clause 6.5.1</Reference>
              <Description>The RRC integrity checks are performed both in the ME and the gNB. In case failed integrity check (i.e. faulty or missing MAC-I) is detected after the start of integrity protection, the concerned message is discarded. This can happen on the gNB side or on the ME side, as specified in TS 33.501 [2], clause 6.5.1.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.2, Control plane data integrity protection</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-CP-DATA-RRC-INT-CHECK_gNB</Name>
              <Purpose>Verify that RRC integrity check failure is handled correctly by the gNB.</Purpose>
              <PreConditions>Test environment with a UE. The UE may be simulated. RRC integrity protection is activated at the gNB.</PreConditions>
              <ExecutionSteps>The UE sends a RRC message to the gNB without MAC-I;
or
The UE sends a RRC message to the gNB with a wrong MAC-I.
NOTE:	RRC integrity protection is provided by PDCP. In a PDCP message without MAC-I, the last 4 Bytes of the PCDP Data will be interpreted as a wrong MAC-I and therefore the integrity check will fail.</ExecutionSteps>
              <ExpectedResults>The RRC message is discarded by the gNB.</ExpectedResults>
              <EvidenceFormat>Sample copies of the log files.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.5	UP integrity check failure" level="5">
            <Requirement>
              <Name>UP integrity check failure</Name>
              <Reference>TS 33.501 [2], clause 6.6.4</Reference>
              <Description>If the gNB or the UE receives a PDCP PDU which fails integrity check with faulty or missing MAC-I after the start of integrity protection, the PDU is discarded as specified in TS 33.501 [2], clause 6.6.4.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.4, User plane data integrity protection</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC_GNB_UP_INTEGRITY_CHECK_FAIL</Name>
              <Purpose>Verify that UP integrity check failure is handled correctly by the gNB.</Purpose>
              <PreConditions>Test environment with a UE. The UE may be simulated. UP integrity protection is activated at the gNB.</PreConditions>
              <ExecutionSteps>The UE sends a PDCP PDU to the gNB without MAC-I;
or
The UE sends a PDCP PDU to the gNB with a wrong MAC-I.
NOTE:	In a PDCP PDU message without MAC-I, the last 4 Bytes of the PCDP PDU Data will be interpreted as a wrong MAC-I and therefore the integrity check will fail.</ExecutionSteps>
              <ExpectedResults>The PDCP PDU is discarded by the gNB.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.6	Ciphering of RRC-signalling" level="5">
            <Requirement>
              <Name>Ciphering of RRC-signalling</Name>
              <Reference>TS 33.501 [2], clause 5.3.2</Reference>
              <Description>The gNB supports ciphering of RRC-signalling as specified in TS 33.501 [2], clause 5.3.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.1 – Control plane data confidentiality protection.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-CP-DATA-CIP-RRC-SIGN_gNB</Name>
              <Purpose>To verify that the RRC-signalling data sent between UE and gNB over the NG RAN air interface are confidentiality protected.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. The UE may be simulated.
-	The tester shall have access to the NG RAN air interface or can capture the message at the UE.</Purpose>
              <ExecutionSteps>1.	The tester triggers the UE to send a Registraton Request to the AMF.
2.	The AMF sends a KgNB and the UE security capability to the gNB.
3.	The gNB selects an algorithm and sends AS SMC to the UE.
4.	The gNB receive AS SMP from the UE.</ExecutionSteps>
              <ExpectedResults>Control plane packets sent to the UE after the gNB sends AS SMC is ciphered.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface, e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.7	Ciphering of user data between the UE and the gNB" level="5">
            <Requirement>
              <Name>Ciphering of user data between the UE and the gNB</Name>
              <Reference>TS 33.501 [2], clause 5.3.2</Reference>
              <Description>The gNB supports ciphering of user data between the UE and the gNB. as specified in TS 33.501 [2], clause 5.3.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.3 – User plane data confidentiality protection at gNB</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-UP-DATA-CIP_gNB</Name>
              <Purpose>To verify that the user data packets are confidentiality protected over the NG RAN air interface.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. The UE may be simulated.
-	The tester shall have access to the NG RAN air interface or can capture the message at the UE.</Purpose>
              <ExecutionSteps>1.	The tester triggers theUE to send PDU session establishment Request to the SMF.
2.	The SMF sends a UP security policy with UP ciphering required or preferred to the gNB.
3.	The gNB sends RRCConnectionReconfiguration with ciphering protection indication &quot;on&quot;.
4.	The tester checks any user data sent by the gNB after sending RRCConnectionReconfiguration and before the UE enters into CM-Idle state.</ExecutionSteps>
              <ExpectedResults>The user plane packets sent to the UE after the gNB sends RRCConnectionReconfiguration is confidentiality protected.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.8	Replay protection of user data between the UE and the gNB" level="5">
            <Requirement>
              <Name>Replay protection of user data between the UE and the gNB.</Name>
              <Reference>TS 33.501 [2], clause 5.3.3</Reference>
              <Description>The gNB supports integrity protection and replay protection of user data as specified in TS 33.501 [2], clause 5.3.3.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.4 – User plane data integrity protection.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-UP-DATA-REPLAY_gNB</Name>
              <Purpose>To verify that the user data packets are replay protected over the NG RAN air interface.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. The UE may be simulated.
-	The tester shall have access to the NG RAN air interface.
-	The tester shall have access to the N3 interface.
-	The tester shall activate the user plane integrity protection of user data packets.</Purpose>
              <ExecutionSteps>1.	The tester shall capture the user plane data sent between UE and gNB using any network analyser over the NG RAN air interface.
2.	Tester shall filter user plane data packets sent between UE and gNB.
3.	Tester shall replay the captured user plane packets or shall use any packet crafting tool to create a user plane packet similar to the captured user plane packet and replay to the gNB.
4.	Tester shall check whether the replayed user plane packets were detected by the gNB by capturing the N3 interface to see if any of the replayed user plane packets have been forwarded by the gNB.
5.	Tester shall verify from the result that if the replayed user plane packets are not accepted by the gNB, the UP of the NG RAN air interface is replay protected.</ExecutionSteps>
              <ExpectedResults>The user plane packets sent between the UE and gNB over the NG air interface is replay protected.</ExpectedResults>
              <EvidenceFormat>-	Evidence suitable for the interface, e.g. Screenshot containing the operational results.
-	Log files, e.g., containing corresponding log events.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.9	Replay protection of RRC-signalling" level="5">
            <Requirement>
              <Name>Replay protection of RRC-signalling.</Name>
              <Reference>TS 33.501 [2], clause 5.3.3</Reference>
              <Description>The gNB supports integrity protection and replay protection of RRC-signalling as specified in TS 33.501 [2], clause 5.3.3.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.2 – Control plane data integrity protection.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-UP-DATA-RRC-REPLAY_gNB</Name>
              <Purpose>To verify the replay protection of RRC-signalling between UE and gNB over the NG RAN air interface.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments.
-	Tester shall have knowledge of the integrity algorithm and the corresponding protection keys.
-	The tester shall have access to the NG RANs air interface.
-	The tester shall have access to the N2 interface.
-	The tester shall activate the integrity protection of RRC-signalling.</Purpose>
              <ExecutionSteps>1.	The tester shall capture the data sent between UE and the gNB using any network analyser over the NG RAN air interface.
2.	Tester shall filter RRC signalling packets.
3.	Tester shall check for the PDCP COUNT of the filtered RRC signalling packets and shall use any packet crafting tool to create RRC signalling packets similar to the captured packets or the tester shall replay the captured RRC uplink packet to the gNB to perform the replay attack over gNB.
4.	Tester shall check whether the replayed RRC signalling packets were detected by the gNB or not, by capturing over NG RAN air interface to see if any corresponding response message is received from the gNB or by capturing the N2 interface to see if any of the replayed RRC signalling  packets have resulted in a message sent by the gNB (e.g. a NAS messages from inside an RRC message).
5.	Tester shall verify from the result that if the replayed RRC signalling packets are not accepted by the gNB, the RRC signalling on the NG RAN air interface is replay protected.</ExecutionSteps>
              <ExpectedResults>The RRC signalling over the NG RAN air interface is replay protected.</ExpectedResults>
              <EvidenceFormat>-	Evidence suitable for the interface, e.g. Screenshot containing the operational results.
-	Log files, e.g., containing corresponding log events.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.10	Ciphering of user data based on the security policy sent by the SMF" level="5">
            <Requirement>
              <Name>Ciphering of user data based on the security policy sent by the SMF</Name>
              <Reference>TS 33.501 [2], clause 5.3.2</Reference>
              <Description>The gNB activates ciphering of user data based on the security policy sent by the SMF as specified in TS 33.501 [2], clause 5.3.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.8 – Security Policy Enforcement.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-UP-DATA-CIP-SMF</Name>
              <Purpose>To verify that activation of confidentiality protection for user data is based on the security policy sent by the SMF via AMF
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. The UE and the 5GC may be simulated.
-	The tester shall have access to the NG RAN air interface.
-	The tester shall have knowledge of the RRC and UP ciphering algorithm and protection keys.
-	RRC ciphering is already activated at the gNB.</Purpose>
              <ExecutionSteps>All execution steps are to be performed two times. Once with the UP security policies’ ciphering protection in step 2 set to &quot;required&quot; and the second time set to &quot;not needed&quot;.
1.	The tester triggers PDU session establishment procedure by sending PDU session establishment request message.
2.	Tester shall trigger the SMF to send the UP security policy with ciphering protection &quot;required&quot; or &quot;not needed&quot; to the gNB.
3.	The tester shall capture the RRC reconfiguration procedure between gNB to UE over NG RAN air interface. And filter the RRC reconfiguration message sent by gNB to UE.
4.	The tester shall decrypt the RRC Reconfiguration message and retrieve the UP ciphering protection indication present in the captured message.
5.	The tester shall verify if the UP security policy received at gNB is same as the UP ciphering protection indication notified by the gNB to the UE in the RRC Reconfiguration message.
6.	Tester shall capture the RRC Reconfiguration complete message sent between UE and gNB.
7.	Tester shall capture the user plane data sent between UE and gNB using any network analyser.</ExecutionSteps>
              <ExpectedResults>When the received UP cipher protection indication is set to “required”, the captured user plane data appear to be garbled (i.e. no longer plaintext) and the user plane packets are confidentiality protected based on the UP security policy sent by the SMF.
When the received UP cipher protection indication is set to &quot;not needed&quot;, the captured user plane data appear to be plaintext and the user plane packets are not confidentiality protected based on the UP security policy sent by the SMF.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface, e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.11	Integrity of user data based on the security policy sent by the SMF" level="5">
            <Requirement>
              <Name>Integrity of user data based on the security policy sent by the SMF</Name>
              <Reference>TS 33.501 [2], clause 5.3.2</Reference>
              <Description>The gNB activates integrity protection of user data based on the security policy sent by the SMF as specified in TS 33.501 [2], clause 5.3.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.8 – Security Policy Enforcement.</ThreatReference>
            </Requirement>
            <TestCase>
              <Name/>
              <Purpose>To verify that activation of integrity protection for user data packets is based on the security policy sent by the SMF.
Pre-Condition:
-	The gNB network product shall be connected in emulated/real network environments. The UE and the 5GC may be simulated.
-	The tester shall have access to the NG RAN air interface.
-	The tester shall have knowledge of the integrity algorithm and protection keys.
-	RRC integrity is activated at the gNB.</Purpose>
              <ExecutionSteps>All execution steps are to be performed two times. Once with the UP security policies’ ciphering protection in step 2 set to &quot;required&quot; and the second time set to &quot;not needed&quot;.
1.	The tester triggers PDU session establishment procedure by sending PDU session establishment request message.
2.	Tester shall trigger the SMF to send the UP security policy with integrity protection is &quot;required&quot; or &quot;not needed&quot; to the gNB.
3.	The tester shall capture the RRC reconfiguration message sent by gNB to UE over NG RAN air interface.
4.	The tester shall decrypt the RRC reconfiguration message and retrieve the UP integrity protection indication presenting in the decrypted message.
5.	Tester shall check whether UP integrity is enabled /disabled to verify if the UP security policy received at gNB is same as the UP integrity protection indication notified by the gNB to the UE in the RRC reconfiguration message.
6.	Tester shall capture the user plane data sent between UE and gNB using any network analyser.</ExecutionSteps>
              <ExpectedResults>When the received UP integrity protection is set to &quot;required&quot;, the user plane packets are integrity protected based on the security policy sent by the SMF.
When the received UP integrity protection is set to &quot;not needed&quot;, the user plane packets are not integrity protected based on the security policy sent by the SMF.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface, e.g. Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.12	AS algorithms selection" level="5">
            <Requirement>
              <Name>AS algorithms selection</Name>
              <Reference>TS 33.501 [2], clause 6.7.3.0 and clause 5.11.2.</Reference>
              <Description>The gNB selects the algorithms to use dependent on: the UE security capabilities of the UE, the configured allowed list of security capabilities of the currently gNB as specified in TS 33.501 [2], clause 5.11.2.
Each gNB is configured via network management with lists of algorithms which are allowed for usage. There is one list for integrity algorithms, and one for ciphering algorithms. These lists are ordered according to a priority decided by the operator as specified in TS 33.501 [2], clause 6.7.3.0.</Description>
              <ThreatReference>TR 33.926 [5], D.2.2.5 – AS algorithm selection and use</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-AS-alg-select_gNB</Name>
              <Purpose>Verify that the gNB selects the algorithms with the highest priority in its configured list.</Purpose>
              <PreConditions>Test environment with the gNB has been pre-configured with allowed security algorithms with priority.</PreConditions>
              <ExecutionSteps>1)	The tester triggers the UE to send registration request message to the gNB.
2)	The gNB receives UE context setup request message.
3)	The gNB sends the AS SECURITY MODE COMMAND message.
4)	The UE replies with the AS SECURITY MODE COMPLETE message.</ExecutionSteps>
              <ExpectedResults>The gNB initiates the SECURITY MODE COMMAND message that includes the chosen algorithm with the highest priority according to the ordered lists and is contained in the UE NR security capabilities.
The MAC in the AS SECURITY MODE COMPLETE message is verified, and the AS protection algorithms are selected and applied correctly.</ExpectedResults>
              <EvidenceFormat>Sample copies of the log files.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.13	Key refresh at the gNB" level="5">
            <Requirement>
              <Name>Key refresh at the gNB</Name>
              <Reference>TS 33.501 [2], clause 6.9.4.1; TS 38.331 [6], clause 5.3.1.2</Reference>
              <Description>Key refresh is possible for KgNB, KRRC-enc, KRRC-int, KUP-enc, and KUP-int (if available), and is to be initiated by the gNB/ng-eNB when a PDCP COUNTs are about to be re-used with the same Radio Bearer identity and with the same KgNB. as specified in TS 33.501 [2], clause 6.9.4.1.
The network is responsible for avoiding reuse of the COUNT with the same RB identity and with the same key, e.g. due to the transfer of large volumes of data, release and establishment of new RBs, and multiple termination point changes for RLC-UM bearers and multiple termination point changes for RLC-AM bearer with SN terminated PDCP re-establishment (COUNT reset) due to SN only full configuration whilst the key stream inputs (i.e. bearer ID, security key) at MN have not been updated. In order to avoid such re-use, the network e.g. uses different RB identities for RB establishments, change the AS security key, or an RRC_CONNECTED to RRC_IDLE/RRC_INACTIVE and then to RRC_CONNECTED transition as specified in TS 38.331 [6], clause 5.3.1.2.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.7 Key Reuse</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC_GNB_KEY_REFRESH_DRB_ID</Name>
              <Purpose>Verify that the gNB performs KgNB refresh when DRB-IDs are about to be reused under the following conditions:
-	the successive Radio Bearer establishment uses the same RB identity while the PDCP COUNT is reset to 0, or
-	the PDCP COUNT is reset to 0 but the RB identity is increased after multiple calls and wraps around.</Purpose>
              <PreConditions>The UE, AMF and SMF may be simulated.</PreConditions>
              <ExecutionSteps>1) The tester triggers the gNB to send the AS Security Mode Command message to the UE.
2)	The UE responds with the AS Security Mode Complete message.
3)	A DRB is set up.
4)	The tester sets up and tears down the DRB for multiple times within one active radio connection without the UE going to idle (e.g. by triggering the UE to make multiple IMS calls, or by triggering the SMF to request PDU session modification and deactivation via the AMF), until the DRB ID is reused.</ExecutionSteps>
              <ExpectedResults>Before DRB ID reuse, the gNB takes a new KgNB into use by e.g. triggering an intra-cell handover or triggering a transition from RRC_CONNECTED to RRC_IDLE or RRC_INACTIVE and then back to RRC_CONNECTED.
NOTE:	Random Access Procedure defined in clause 9.2.6 of TS 38.300[8] runs in the above procedures.</ExpectedResults>
              <EvidenceFormat>Part of log that shows all the DRB identities and the corresponding procedure. This part can be presented, for example, as a screenshot.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.14	Bidding down prevention in Xn-handovers" level="5">
            <Requirement>
              <Name>Bidding Down Prevention</Name>
              <Reference>TS 33.501 [2], clause 6.7.3.1</Reference>
              <Description>In the Path-Switch message, the target gNB/ng-eNB sends the UE's 5G security capabilities received from the source gNB/ng-eNB to the AMF. as specified in TS 33.501 [2], clause 6.7.3.1.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.6 Bidding Down on Xn-Handover</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC-Xn-handover_bid_down_gNB</Name>
              <Purpose>Verify that bidding down is prevented in Xn-handovers.</Purpose>
              <PreConditions>Test environment with source gNB and target gNB, and the source gNB may be simulated.</PreConditions>
              <ExecutionSteps>The tester triggers the target gNB to send the path-switch message to the AMF.</ExecutionSteps>
              <ExpectedResults>The UE NR security capabilities are in the path-switch message.</ExpectedResults>
              <EvidenceFormat>Snapshots containing the result.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.15	AS protection algorithm selection in gNB change" level="5">
            <Requirement>
              <Name>AS protection algorithm selection in gNB change.</Name>
              <Reference>TS 33.501 [2], clauses 6.7.3.1 and 6.7.3.2</Reference>
              <Description>The target gNB/ng-eNB selects the algorithm with highest priority from the received 5G security capabilities of the UE according to the prioritized locally configured list of algorithms (this applies for both integrity and ciphering algorithms). The chosen algorithms are indicated to the UE in the Handover Command message if the target gNB/ng-eNB selects different algorithms compared to the source gNB/ng-eNB as specified in TS 33.501 [2], clause 6.7.3.1, and clause 6.7.3.2.</Description>
              <ThreatReference>TR 33.926 [5], D.2.2.5 – AS algorithm selection and use</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>Alg_select_change_gNB</Name>
              <Purpose>Verify that AS protection algorithm is selected correctly.</Purpose>
              <PreConditions>Test environment with source gNB, target gNB and AMF. Source gNB and AMF may be simulated.</PreConditions>
              <ExecutionSteps>Test Case 1:
1.	The tester triggers the source gNB to transfer the ciphering and integrity algorithms used in the source cell to the target gNB in the handover request message.
2.	Target gNB verifies the algorithms and selects AS algorithms which have the highest priority according to the ordered lists. Target gNB includes the algorithm in the handover command.
Test Case 2:
1.	The tester triggers the AMF to send the UE NR security capability to the Target gNB.
2.	The target gNB selects the AS algorithms which have the highest priority according to the ordered lists in the HANDOVER COMMAND.
The above test cases assume that the algorithms selected by the target gNB are different from the ones received from the source gNB.</ExecutionSteps>
              <ExpectedResults>For both test cases:
The selected AS ciphering and integrity protection algorithms in the handover complete message have the highest priority according to the ordered list.
The MAC in the handover complete message is valid and is based on the correctly selected AS ciphering and integrity protection algorithms.</ExpectedResults>
              <EvidenceFormat>Snapshots containing the result.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.16	Control plane data confidentiality protection over N2/Xn interface" level="5">
            <Requirement>
              <Name>Control plane data confidentiality protection over N2/Xn interface</Name>
              <Reference>TS 33.501 [2], clauses 9.2 and 9.4</Reference>
              <Description>The transport of control plane data over N2 is integrity, confidentiality and replay-protected. The transport of control plane data and user data over Xn is integrity, confidentiality and replay-protected, as specified in TS 33.501 [2], clauses 9.2 and 9.4.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.1 – Control plane data confidentiality protection.</ThreatReference>
            </Requirement>
          </Section>
          <Section title="4.2.2.1.17	Control plane data integrity protection over N2/Xn interface" level="5">
            <Requirement>
              <Name>Control plane data integrity protection over N2/Xn interface</Name>
              <Reference>TS 33.501[2], clauses 9.2 and 9.4</Reference>
              <Description>The transport of control plane data over N2 is integrity, confidentiality and replay-protected. The transport of control plane data and user data over Xn is integrity, confidentiality and replay-protected. as specified in TS 33.501 [2], clauses 9.2 and 9.4.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.2 – Control plane data integrity protection.</ThreatReference>
            </Requirement>
          </Section>
          <Section title="4.2.2.1.18	Key update at the gNB on dual connectivity" level="5">
            <Requirement>
              <Name>Key update at the gNB on dual connectivity</Name>
              <Reference>TS 33.501 [2], clause 6.10.2.1; clause 6.10.2.2.1; clause 6.10.3.1.</Reference>
              <Description>When executing the procedure for adding subsequent radio bearer(s) to the same SN, the MN is expected to, for each new radio bearer, assign a radio bearer identity that has not previously been used since the last KSN change. If the MN cannot allocate an unused radio bearer identity for a new radio bearer in the SN, due to radio bearer identity space exhaustion, the MN is expected to increment the SN Counter and compute a fresh KSN, and then is expected to perform a SN Modification procedure to update the KSN as specified in TS 33.501 [2], clause 6.10.2.1.
The MN is expected to refresh the root key of the 5G AS security context associated with the SN Counter before the SN Counter wraps around. Refreshing the root key is done using intra cell handover as described in subclause 6.7.3.3 of TS 33.501 [2]. When the root key is refreshed, the SN Counter is reset to '0' as defined above. in that same clause; as specified in TS 33.501 [2], clause 6.10.3.1.
NOTE:	The following testcases are only tested when the NR-NR DC, NE-DC and EN-DC scenarios are deployed.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.7 Key Reuse</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC_GNB_DC_KEY_UPDATE_DRB_ID</Name>
              <Purpose>Verify that the gNB under test acting as a Master Node (MN) performs KSN update when DRB-IDs are about to be reused.</Purpose>
              <PreConditions>-	Test environment with a gNB or ng-eNB acting as the Secondary Node (SN), which may be simulated
-	Test environment with a UE, SMF and AMF, which may be simulated</PreConditions>
              <ExecutionSteps>1.	The tester triggers the gNB under test to establish RRC connection and AS security context with the UE.
2.	The gNB under test establishes security context between the UE and the SN for the given AS security context shared between the gNB under test and the UE; and generates a KSN sent to the SN.
3.	A SCG bearer is set up between the UE and the SN.
4.	The tester triggers the gNB under test to execute the SN Modification procedure to provide additional available DRB IDs to be used for SN terminated bearers (e.g. by triggering the UE to make multiple IMS calls, or by triggering the SMF to request PDU session modification and deactivation via the AMF), until the DRB IDs are reused.</ExecutionSteps>
              <ExpectedResults>-	Before DRB ID reuse, the gNB under test generates a new KSN and sends it via the SN Modification Request message to the SN.</ExpectedResults>
              <EvidenceFormat>Evidence suitable for the interface, e.g. text representation of the captured SN Modification Request message.
Test Case 2:</EvidenceFormat>
            </TestCase>
            <TestCase>
              <Name>TC_GNB_DC_KEY_UPDATE_SN_COUNTER</Name>
              <Purpose>Verify that the gNB under test acting as a Master Node (MN) performs KNG-RAN(AS root key) update when SN COUNTER is about to wrap around.</Purpose>
              <PreConditions>-	Test environment with a gNB or ng-eNB acting as the Secondary Node (SN), which may be simulated
-	Test environment with a UE, SMF and AMF, which may be simulated.</PreConditions>
              <ExecutionSteps>1.	The tester triggers the gNB under test to establish RRC connection and AS security context with the UE.
2.	The gNB under test establishes security context between the UE and the SN for the given AS security context shared between the gNB under test and the UE; and generates a KSN sent to the SN and increases the value of SN Counter.
3.	A SCG bearer is set up between the UE and the SN.
4.	The tester triggers the gNB under test to execute the SN Modification procedure to provide updated KSN to SN, until the SN Counter value wraps around.</ExecutionSteps>
              <ExpectedResults>-	Before SN Counter wraps around, the gNB under test takes a new KNG-RAN into use by e.g. triggering an intra-cell handover or triggering a transition from RRC_CONNECTED to RRC_IDLE or RRC_INACTIVE and then back to RRC_CONNECTED.
NOTE:	Random Access Procedure defined in clause 9.2.6 of TS 38.300[8] runs in the above procedures.</ExpectedResults>
              <EvidenceFormat>Part of log that shows the SN Counter values before and after wrapping around and the corresponding procedure. This part can be presented, for example, as a screenshot.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.19	UP security activation in Inactive scenario" level="5">
            <Requirement>
              <Name>UP security activation in Inactive scenario</Name>
              <Reference>TS 33.501 [2], clause 6.8.2.1.3.</Reference>
              <Description>If the UP security activation status can be supported in the target gNB/ng-eNB, the target gNB/ng-eNB uses the UP security activations that the UE used at the last source cell. Otherwise, the target gNB/ng-eNB responds with an RRC Setup message to establish a new RRC connection with the UE as specified in TS 33.501 [2], clause 6.8.2.1.3.
Threat Reference:  TR 33.926 [5], clause D.2.2.9 State transition from inactive state to connected state.
Test Case:</Description>
            </Requirement>
            <TestCase>
              <Name>TC_GNB_INACTIVE_TO_ACTIVE</Name>
              <Purpose>Verify that the target gNB/ng-eNB uses the UP security activation status to activate the UP security.</Purpose>
              <PreConditions>-	The gNB network product shall be connected in emulated/real network environments.
-	The UE may be simulated.</PreConditions>
              <ExecutionSteps>1.	The tester shall complete a Registration Procedure and PDU Session establishment procedure to make sure the gNB configure the UP security, and get the UP security activation status.
2.	The gNB sends RRC Release message with a suspend config to the UE.
3.	The tester deletes the UP security activation status of the UE.
4.	The tester triggers the UE to send RRC Resume message.</ExecutionSteps>
              <ExpectedResults>The gNB sends RRC Setup message to the UE.</ExpectedResults>
              <EvidenceFormat>Screenshot containing the operational results.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.20	User plane data confidentiality protection over N3/Xn interface" level="5">
            <Requirement>
              <Name>User plane data confidentiality protection over N3/Xn interface</Name>
              <Reference>TS 33.501 [2], clauses 9.3 and 9.4</Reference>
              <Description>The transport of user data over N3 is integrity, confidentiality and replay-protected.
The transport of control plane data and user data over Xn is integrity, confidentiality and replay-protected as specified in TS 33.501 [2], clauses 9.3 and 9.4.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.3 – User plane data confidentiality protection at gNB.</ThreatReference>
            </Requirement>
          </Section>
          <Section title="4.2.2.1.21	User plane data integrity protection over N3/Xn interface" level="5">
            <Requirement>
              <Name>User plane data integrity protection over N3/Xn interface</Name>
              <Reference>TS 33.501[2], clauses 9.3 and 9.4</Reference>
              <Description>The transport of user data over N3 is integrity, confidentiality and replay-protected.
The transport of control plane data and user data over Xn is integrity, confidentiality and replay-protected as specified in TS 33.501 [2], clauses 9.3 and 9.4.</Description>
              <ThreatReference>TR 33.926 [5], clause D.2.2.4 – User plane data integrity protection</ThreatReference>
            </Requirement>
          </Section>
          <Section title="4.2.2.1.22	Checking expiry certificate" level="5">
            <Requirement>
              <Name>Expired Certificate checking at base station</Name>
              <Reference>TS 33.310 [10], clause 7.2</Reference>
              <Description>Certificate Management Protocol v2 (CMPv2) [11] may be the supported protocol to provide certificate lifecycle management capabilities for TLS entities. All TLS entities and TLS CAs may support initial enrolment by the TLS entity to the TLS CA via CMPv2, i.e. receiving a certificate from the TLS CA, and updating the key of the certificate via CMPv2 before the certificate expires.</Description>
              <ThreatReference>TBD</ThreatReference>
            </Requirement>
            <TestCase>
              <Name>TC_EXPIR_CERT_CHCK</Name>
              <Purpose>Verify that the gNB can check whether its certificate issued by operator CA is about to expire and to act accordingly.</Purpose>
              <PreConditions>-	If the gNB under test does not support handling certificates as defined in clause 9 of TS 33.310[10], this test does not apply.
-	The gNB network product is connected in emulated/real network environments.
-	A TLS CA may be emulated, if needed.
-	The gNB is configured the necessary information to connect with the CA server.
-	Optionally, the vendor may provide necessary information in a document, e.g. describing how to handle the case when a gNB checks the operator certificate is about to be expired.</PreConditions>
              <ExecutionSteps>1.	The tester configures the gNB with certificates that is assigned by operator CA.
2.	The tester configures the UTC timer of gNB to the time when its own certificate is about to be expired.
3.	The gNB initiates the CMPv2 procedure to get the new operator certificate.</ExecutionSteps>
              <ExpectedResults>-	The gNB raises an alarm or requests a new certificate from the CA.
-	The gNB received a new operator certificate.</ExpectedResults>
              <EvidenceFormat>The logs and the communication flow in a .pcap file.</EvidenceFormat>
            </TestCase>
          </Section>
          <Section title="4.2.2.1.23	Peer certificate checking" level="5">
            <Requirement>
              <Name>Peer certificate checking at base station</Name>
              <Reference>TS 33.310 [10], clause 9.5.1</Reference>
              <Description>-	The base station may be pre-provisioned with the operator root CA certificate.
-	If the base station is not pre-provisioned with the operator root CA certificate, then the base station takes the operator root certificate from the certificates received in the initialization response. The selection is based on checking which root certificate can be used to validate the received base station certificate.
NOTE1:	Examples on validation factors defined in clause 6.3.1 of TS 33.310[10] can be taken into consideration, for example, whether the certificated has been revoked, expired, on the CRL distribution point is empty, etc.
Test case:</Description>
            </Requirement>
            <TestCase>
              <Name>TC_PEER_CERT_CHCK</Name>
              <Purpose>Verify that the gNB has the ability to check the peer certificate is valid or not.</Purpose>
              <PreConditions>-	If the gNB under test does not support handling certificates as defined in clause 9 of TS 33.310[10], this test does not apply.
-	The gNB is configured with or has obtained an operator root CA certificate.
-	The gNB network product shall be connected in emulated/real network environments.
-	A peer, e.g., AMF, SEG, gNB may be emulated.
NOTE2:	According to 5GS, only AMF, SEG/UPF, gNB can connect to a gNB. The peer means the network function that provides the operator assigned certificate to the gNB for establishing the N2, N3, Xn interfaces.
-	The gNB is configured the necessary information to connect with the peer.
-	Optionally, the vendor may provide necessary information in a document, e.g., describing the checking factors and how to handle the case when a gNB validate the certificate is invalid.</PreConditions>
              <ExecutionSteps>1.	The tester configures the peer with an invalid certificate e.g., by using a wrong signature or a certificate that has expired.
2.	The tester triggers the gNB to connect to the peer.</ExecutionSteps>
              <ExpectedResults>The gNB does not connect with the peer and may raise an alarm at the same time.</ExpectedResults>
              <EvidenceFormat>The logs and the communication flow in a .pcap file.</EvidenceFormat>
            </TestCase>
          </Section>
        </Section>
      </Section>
      <Section title="4.2.3	Technical Baseline" level="3">
        <Section title="4.2.3.1	Introduction" level="4"/>
        <Section title="4.2.3.2	Protecting data and information" level="4">
          <Section title="4.2.3.2.1	Protecting data and information – general" level="5"/>
          <Section title="4.2.3.2.2	Protecting data and information – unauthorized viewing" level="5"/>
          <Section title="4.2.3.2.3	Protecting data and information in storage" level="5"/>
          <Section title="4.2.3.2.4	Protecting data and information in transfer" level="5"/>
          <Section title="4.2.3.2.5	Logging access to personal data" level="5"/>
        </Section>
        <Section title="4.2.3.3	Protecting availability and integrity" level="4"/>
        <Section title="4.2.3.4	Authentication and authorization" level="4">
          <Section title="4.2.3.4.1	Authentication attributes" level="5"/>
        </Section>
        <Section title="4.2.3.5	Protecting sessions" level="4"/>
        <Section title="4.2.3.6	Logging" level="4"/>
      </Section>
      <Section title="4.2.4	Operating systems" level="3"/>
      <Section title="4.2.5	Web servers" level="3"/>
      <Section title="4.2.6	Network devices" level="3">
        <Section title="4.2.6.1	Protection of data and information" level="4"/>
        <Section title="4.2.6.2	Protecting availability and integrity" level="4">
          <Section title="4.2.6.2.1	Packet filtering" level="5"/>
          <Section title="4.2.6.2.2	Interface robustness requirements" level="5"/>
          <Section title="4.2.6.2.3	GTP-C Filtering" level="5"/>
          <Section title="4.2.6.2.4	GTP-U Filtering" level="5"/>
        </Section>
      </Section>
      <Section title="4.2.7	Void" level="3"/>
    </Section>
    <Section title="4.3	gNodeB-specific adaptations of hardening requirements and related test cases." level="2">
      <Section title="4.3.1	Introduction" level="3"/>
      <Section title="4.3.2	Technical Baseline" level="3"/>
      <Section title="4.3.3	Operating Systems" level="3"/>
      <Section title="4.3.4	Web Servers" level="3"/>
      <Section title="4.3.5	Network Devices" level="3"/>
      <Section title="4.3.6	Network Functions in service-based architecture" level="3"/>
    </Section>
    <Section title="4.4	gNodeB-specific adaptations of basic vulnerability testing requirements and related test cases" level="2"/>
    <Section title="4.4.1	Introduction" level="2">
      <Section title="4.4.2	Port Scanning" level="3"/>
      <Section title="4.4.3	Vulnerability scanning" level="3"/>
      <Section title="4.4.4	Robustness and fuzz testing" level="3">
        <Section title="Annex A (informative):
Change history" level="8"/>
      </Section>
    </Section>
  </Section>
</Specification>
